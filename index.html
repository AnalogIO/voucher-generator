<!DOCTYPE html>
<html>

<head>
    <title>Voucher generator</title>
</head>

<body>
    <h1>Voucher generator</h1>
    <div id="content"></div>
    <table id="products">
        <thead>
            <tr>
                <th>Amount to Generate</th>
                <th>Name</th>
                <th>ID</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <!-- Products will be inserted here -->
        </tbody>
    </table>
    <button onclick="generateVouchers()">Generate!</button>

    <script>
        class Tuple extends Array {
            constructor(...items) {
                super(...items);
                Object.freeze(this);
            }

            toString() {
                return `Tuple(${this.join(", ")})`;
            }
        }

        const API_BASE = "https://core.prd.analogio.dk";
        let authToken = localStorage.getItem("authToken");
        let userInfo = {};

        if (!authToken) {
            document.getElementById("content").innerHTML = '<p>You are not authenticated. <a href="login.html">Login</a></p>';
        } else {
            fetch(API_BASE + "/api/v2/account", {
                headers: {
                    "Authorization": `Bearer ${authToken}`
                }
            })
                .then(response => {
                    if (response.status === 200) {
                        return response.json();
                    } else {
                        throw new Error("Your authentication token expired.");
                    }
                })
                .then(data => {
                    userInfo = data;
                    if (userInfo.role === "Customer" || userInfo.role === "Barista") {
                        throw new Error("You don't have rights to generate vouchers.");
                    }
                    document.getElementById("content").innerHTML = `<p>Hi ${userInfo.name} (${userInfo.email})</p>`;
                    return fetch(API_BASE + "/api/v1/Products");
                })
                .then(response => response.json())
                .then(data => {
                    let productHTML = "";
                    data.forEach(product => {
                        productHTML += `<tr>
                            <td><input type="number" id="amount-${product.id}" min="0" value="0"></td>
                            <td>${product.name}</td>
                            <td>${product.id}</td>
                            <td>${product.description}</td>
                        </tr>`;
                    });
                    document.getElementById("products").querySelector("tbody").innerHTML = productHTML;
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>' +
                        error + ' <a href="login.html">Login</a></p>';
                });
        }

        function generateVouchers() {
            const tableRows = document.getElementById("products").querySelectorAll("tbody tr");
            let generateList = [];
            let summary = "You will generate vouchers for:\n";

            tableRows.forEach(row => {
                const name = row.cells[1].innerText;
                const id = row.cells[2].innerText;

                const amount = document.getElementById(`amount-${id}`).value;
                if (!amount) return;

                generateList.push(new Tuple(id, amount));

            });

            alert(generateList);
        }
    </script>
</body>

</html>