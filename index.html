<!DOCTYPE html>
<html>

<head>
    <title>Voucher generator</title>
</head>

<body>
    <h1>Voucher generator</h1>
    <div id="content"></div>
    <form id="form" hidden>
        <fieldset>
            <legend>Select vouchers to generate</legend>
            <table id="products">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Name</th>
                        <th>ID</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" id="amount-6" min="0" value="0"></td>
                        <td>Single filter</td>
                        <td>6</td>
                    </tr>
                    <tr>
                        <td><input type="number" id="amount-15" min="0" value="0"></td>
                        <td>Single fancy</td>
                        <td>15</td>
                    </tr>
                    <tr>
                        <td><input type="number" id="amount-7" min="0" value="0"></td>
                        <td>10 filter</td>
                        <td>7</td>
                    </tr>
                    <tr>
                        <td><input type="number" id="amount-14" min="0" value="0"></td>
                        <td>10 fancy</td>
                        <td>14</td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
        <fieldset>
            <legend>Additional details (required)</legend>
            <label for="voucherPrefix">Voucher Prefix (3 letters):</label>
            <input type="text" id="voucherPrefix" minlength="3" maxlength="3" required>
            <label for="description">Description:</label>
            <input type="text" id="description" required>
            <label for="requester">Requester:</label>
            <input type="text" id="requester" required>
        </fieldset>
        <input type="submit" value="Generate!">
    </form>
    <div id="issuedVouchers"></div>

    <script>
        const API_BASE = "https://core.prd.analogio.dk";
        let authToken = localStorage.getItem("authToken");
        let userInfo = {};

        if (!authToken) {
            document.getElementById("content").innerHTML = '<p>You are not authenticated. <a href="login.html">Login</a></p>';
        } else {
            fetch(API_BASE + "/api/v2/account", {
                headers: {
                    "Authorization": `Bearer ${authToken}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    userInfo = data;
                    document.getElementById("content").innerHTML = `<p>Hi ${userInfo.name} (${userInfo.email})</p>`;
                    document.getElementById("form").toggleAttribute("hidden");
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById("content").innerHTML = '<p>' + error + ' <a href="login.html">Login</a></p>';
                });
        }

        document.getElementById("form").addEventListener("submit", generateVouchers);

        async function generateVouchers(event) {
            event.preventDefault(); // Prevent form from submitting

            const voucherPrefix = document.getElementById("voucherPrefix").value;
            const description = document.getElementById("description").value;
            const requester = document.getElementById("requester").value + " (via Voucher Generator)";

            const tableRows = document.getElementById("products").querySelectorAll("tbody tr");
            let issuedVouchers = {};

            for (const row of tableRows) {
                const name = row.cells[1].innerText;
                const id = row.cells[2].innerText;
                const amount = document.getElementById(`amount-${id}`).value;

                if (amount <= 0) continue;

                const payload = {
                    "ProductId": parseInt(id),
                    "Amount": parseInt(amount),
                    "VoucherPrefix": voucherPrefix,
                    "Description": description,
                    "Requester": requester
                };

                const response = await fetch(API_BASE + "/api/v2/vouchers/issue-vouchers", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    issuedVouchers[name] = data;
                } else {
                    console.error(`Failed to issue vouchers for ${name}`);
                }
            }

            document.getElementById("form").toggleAttribute("hidden");
            displayIssuedVouchers(issuedVouchers);
        }

        function displayIssuedVouchers(issuedVouchers) {
            let outputHTML = "<h2>Issued Vouchers:</h2>";

            for (const [productName, vouchers] of Object.entries(issuedVouchers)) {
                outputHTML += `<h3>${productName} vouchers:</h3><pre><code>`;
                vouchers.forEach(voucher => {
                    outputHTML += `${voucher.voucherCode}\n`;
                });
                outputHTML += "</code></pre>";
            }

            document.getElementById("issuedVouchers").innerHTML = outputHTML;
        }
    </script>
</body>

</html>